<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B√°nh Trung Thu Nh√¢n Tr√°i Tim</title>
  <style>
    body {
      margin: 0;
      background: #a03034;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }
    canvas#cake {
      background: transparent;
    }
    #heart-container, #filling-canvas {
      position: absolute;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    #heart-container {
      display: none;
      justify-content: center;
      align-items: center;
    }
    #pinkboard {
      width: 280px;
      height: 280px;
      display: block;
    }
    button {
      position: absolute;
      bottom: 30px;
      padding: 10px 20px;
      font-size: 18px;
      background: #e3a63b;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 0 #d1902e;
    }
  </style>
</head>
<body>
  <canvas id="cake" width="600" height="600"></canvas>
  <button id="cutButton">üç∞ C·∫Øt B√°nh Xem Nh√¢n</button>

  <audio id="bg-music" preload="auto" loop>
    <source src="music.mp3" type="audio/mpeg">
    Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t nh·∫°c.
  </audio>

  <canvas id="filling-canvas" width="280" height="280"></canvas>

  <div id="heart-container">
    <canvas id="pinkboard"></canvas>
  </div>

<script>
/* ---------- V·∫Ω b√°nh ƒë·∫ßy ƒë·ªß ---------- */
const canvas = document.getElementById("cake");
const ctx = canvas.getContext("2d");
const cx = 300, cy = 300, r = 180;
let cutProgress = 0, cutting = false, maxOffset = 200;

const tempCanvas = document.createElement('canvas');
tempCanvas.width = canvas.width;
tempCanvas.height = canvas.height;
const tempCtx = tempCanvas.getContext('2d');

drawWholeCake(tempCtx);
const fullImage = tempCtx.getImageData(0, 0, canvas.width, canvas.height);

const leftImage = ctx.createImageData(cx, canvas.height);
const rightImage = ctx.createImageData(canvas.width - cx, canvas.height);

for (let y = 0; y < canvas.height; y++) {
  for (let x = 0; x < cx; x++) {
    const s = (y * canvas.width + x) * 4;
    const d = (y * cx + x) * 4;
    for (let i = 0; i < 4; i++) leftImage.data[d+i] = fullImage.data[s+i];
  }
}
for (let y = 0; y < canvas.height; y++) {
  for (let x = cx; x < canvas.width; x++) {
    const s = (y * canvas.width + x) * 4;
    const d = (y * (canvas.width - cx) + (x - cx)) * 4;
    for (let i = 0; i < 4; i++) rightImage.data[d+i] = fullImage.data[s+i];
  }
}

function drawScene(offset = 0) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.putImageData(leftImage, -offset, 0);
  ctx.putImageData(rightImage, cx + offset, 0);
}

function drawWholeCake(context) {
  // Vi·ªÅn scallop
  context.beginPath();
  drawScallop(context, cx, cy, r, 16);
  context.fillStyle = "#e3a63b";
  context.fill();
  context.lineWidth = 8;
  context.strokeStyle = "#d1902e";
  context.stroke();

  // Th√™m v√¢n b√°nh (ƒë∆∞·ªùng k·∫ª nh·ªè b√™n trong)
  for (let rr = 130; rr < r - 10; rr += 8) {
    context.beginPath();
    context.arc(cx, cy, rr, 0, Math.PI * 2);
    context.strokeStyle = "rgba(209,144,46,0.25)";
    context.lineWidth = 2;
    context.stroke();
  }

  // V√≤ng tr√≤n b√™n trong
  context.beginPath();
  context.arc(cx, cy, 120, 0, Math.PI*2);
  context.lineWidth = 10;
  context.strokeStyle = "#d1902e";
  context.stroke();

  // Hoa vƒÉn 8 c√°nh
  context.strokeStyle = "#d1902e";
  context.lineWidth = 10;
  for(let i=0; i<8; i++){
    const angle = i * Math.PI/4;
    const x = cx + Math.cos(angle) * 70;
    const y = cy + Math.sin(angle) * 70;
    context.save();
    context.translate(x, y);
    context.rotate(angle);
    context.beginPath();
    context.ellipse(5, 5, 30, 60, 0, 0, Math.PI*2);
    context.stroke();
    context.restore();
  }

  // H√¨nh vu√¥ng trung t√¢m + d·∫•u c·ªông
  const s = 50;
  context.strokeStyle = "#d1902e";
  context.lineWidth = 10;
  context.strokeRect(cx - s/2, cy - s/2, s, s);

  context.beginPath();
  context.moveTo(cx, cy - s/2);
  context.lineTo(cx, cy + s/2);
  context.stroke();

  context.beginPath();
  context.moveTo(cx - s/2, cy);
  context.lineTo(cx + s/2, cy);
  context.stroke();
}

function drawScallop(context, centerX, centerY, radius, petals) {
  const petalRadius = radius / 6;
  const step = (Math.PI * 2) / petals;
  context.beginPath();
  for (let i = 0; i < petals; i++) {
    const angle = i * step;
    const x = centerX + Math.cos(angle) * radius;
    const y = centerY + Math.sin(angle) * radius;
    const midAngle = angle + step / 2;
    const mx = centerX + Math.cos(midAngle) * (radius + petalRadius);
    const my = centerY + Math.sin(midAngle) * (radius + petalRadius);
    const nx = centerX + Math.cos(angle + step) * radius;
    const ny = centerY + Math.sin(angle + step) * radius;
    if (i === 0) context.moveTo(x, y);
    context.quadraticCurveTo(mx, my, nx, ny);
  }
  context.closePath();
}

function animateCut() {
  if (!cutting) return;
  cutProgress += 0.02;
  if (cutProgress >= 1) {
    cutProgress = 1;
    cutting = false;
    startFillingEffect();
  }
  const offset = cutProgress * maxOffset;
  drawScene(offset);
  requestAnimationFrame(animateCut);
}

/* --- Nh·∫°c + tim ƒë·∫≠p --- */
let audioCtx, analyser, freqData;
function setupAudioAnalyser(){
  const music = document.getElementById("bg-music");
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const source = audioCtx.createMediaElementSource(music);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  freqData = new Uint8Array(analyser.frequencyBinCount);
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
}
function startBeatWithMusic(){
  const heartContainer = document.getElementById("heart-container");
  const fillingCanvas = document.getElementById("filling-canvas");

  function animateBeat(){
    if (analyser){
      analyser.getByteFrequencyData(freqData);
      let bass = 0, count = 15;
      for (let i=0;i<count;i++) bass += freqData[i];
      bass = bass / count / 255;
      let scale = 1 + bass * 0.4;

      heartContainer.style.transform = `translate(-50%, -50%) scale(${scale})`;
      fillingCanvas.style.transform = `translate(-50%, -50%) scale(${scale})`;
    }
    requestAnimationFrame(animateBeat);
  }
  animateBeat();
}

document.getElementById("cutButton").addEventListener("click", () => {
  if (!cutting && cutProgress === 0) {
    cutting = true;
    animateCut();
    const music = document.getElementById("bg-music");
    if (!audioCtx){ setupAudioAnalyser(); }
    if (music.paused) {
      music.play().then(()=>audioCtx.resume());
    }
    startBeatWithMusic();
  }
});

drawScene(0);

/* ---------- Hi·ªáu ·ª©ng nh√¢n tr√°i tim h·ªìng ---------- */
const fillCanvas = document.getElementById('filling-canvas');
const fillCtx = fillCanvas.getContext('2d');
let fillRadius = 0;
let filling = false;

function drawHeartPath(ctx){
  ctx.beginPath();
  for (let t = -Math.PI; t < Math.PI; t += 0.01) {
    const x = 80*Math.pow(Math.sin(t),3);
    const y = 65*Math.cos(t)-25*Math.cos(2*t)-13*Math.cos(3*t)-7*Math.cos(4*t)+20;
    const px = fillCanvas.width/2 + x;
    const py = fillCanvas.height/2 - y;
    if (t === -Math.PI) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.closePath();
}

function startFillingEffect(){
  filling = true;
  fillRadius = 0;
  fillCtx.clearRect(0,0,fillCanvas.width,fillCanvas.height);
  animateFilling();
}

function animateFilling(){
  if (!filling) return;
  fillCtx.clearRect(0,0,fillCanvas.width,fillCanvas.height);
  fillCtx.save();
  drawHeartPath(fillCtx);
  fillCtx.clip();

  const grad = fillCtx.createRadialGradient(
    fillCanvas.width/2, fillCanvas.height/2, 0,
    fillCanvas.width/2, fillCanvas.height/2, fillRadius
  );
  grad.addColorStop(0, '#ff9ac9');
  grad.addColorStop(1, '#ff5ca4');

  fillCtx.fillStyle = grad;
  fillCtx.beginPath();
  fillCtx.arc(fillCanvas.width/2, fillCanvas.height/2, fillRadius, 0, Math.PI*2);
  fillCtx.fill();
  
  fillCtx.restore();

  fillRadius += 3;
  if (fillRadius < 150) {
    requestAnimationFrame(animateFilling);
  } else {
    filling = false;
    showHeartParticle();
    drawLoveText();
  }
}

function drawLoveText(){
  fillCtx.save();
  fillCtx.fillStyle = "#fff";
  fillCtx.font = "bold 10px Arial";
  fillCtx.textAlign = "center";
  fillCtx.fillText("Ch√∫c B√© Iu Trung Thu Vui V·∫ª üòò", fillCanvas.width/2, fillCanvas.height/2 - 15);
  fillCtx.restore();
}

/* ---------- Tr√°i tim particle ---------- */
function showHeartParticle(){
  document.getElementById('heart-container').style.display = 'flex';
  initParticleHeart();
}

/* --- Code particle gi·ªØ nguy√™n --- */
function initParticleHeart(){
  const settings={particles:{length:1200,duration:2,velocity:70,effect:-1.3,size:8}};
  var Point=function(x,y){this.x=x||0;this.y=y||0};
  Point.prototype={clone:function(){return new Point(this.x,this.y)},length:function(l){if(l===undefined)return Math.sqrt(this.x*this.x+this.y*this.y);this.normalize();this.x*=l;this.y*=l;return this},normalize:function(){var l=this.length();this.x/=l;this.y/=l;return this}};
  var Particle=function(){this.position=new Point();this.velocity=new Point();this.acceleration=new Point();this.age=0};
  Particle.prototype={initialize:function(x,y,dx,dy){this.position.x=x;this.position.y=y;this.velocity.x=dx;this.velocity.y=dy;this.acceleration.x=dx*settings.particles.effect;this.acceleration.y=dy*settings.particles.effect;this.age=0},update:function(dt){this.position.x+=this.velocity.x*dt;this.position.y+=this.velocity.y*dt;this.velocity.x+=this.acceleration.x*dt;this.velocity.y+=this.acceleration.y*dt;this.age+=dt},draw:function(c,image){function ease(t){return(--t)*t*t+1}var size=image.width*ease(this.age/settings.particles.duration);c.globalAlpha=1-this.age/settings.particles.duration;c.drawImage(image,this.position.x-size/2,this.position.y-size/2,size,size)}};

  var ParticlePool=function(length){particles=new Array(length);for(var i=0;i<particles.length;i++)particles[i]=new Particle();this.firstActive=0;this.firstFree=0;this.duration=settings.particles.duration;this.particles=particles};
  ParticlePool.prototype.add=function(x,y,dx,dy){this.particles[this.firstFree].initialize(x,y,dx,dy);this.firstFree=(this.firstFree+1)%this.particles.length;if(this.firstFree==this.firstActive)this.firstActive=(this.firstActive+1)%this.particles.length};
  ParticlePool.prototype.update=function(dt){var i;if(this.firstActive<this.firstFree){for(i=this.firstActive;i<this.firstFree;i++)this.particles[i].update(dt)}if(this.firstFree<this.firstActive){for(i=this.firstActive;i<this.particles.length;i++)this.particles[i].update(dt);for(i=0;i<this.firstFree;i++)this.particles[i].update(dt)}while(this.particles[this.firstActive].age>=this.duration&&this.firstActive!=this.firstFree){this.firstActive=(this.firstActive+1)%this.particles.length}};
  ParticlePool.prototype.draw=function(c,image){if(this.firstActive<this.firstFree){for(i=this.firstActive;i<this.firstFree;i++)this.particles[i].draw(c,image)}if(this.firstFree<this.firstActive){for(i=this.firstActive;i<this.particles.length;i++)this.particles[i].draw(c,image);for(i=0;i<this.firstFree;i++)this.particles[i].draw(c,image)}};

  var canvas=document.getElementById('pinkboard');
  var context=canvas.getContext('2d'),
      pool=new ParticlePool(settings.particles.length),
      rate=settings.particles.length/settings.particles.duration,
      time;

  function pointOnHeart(t){
    return new Point(
      80*Math.pow(Math.sin(t),3),
      65*Math.cos(t)-25*Math.cos(2*t)-13*Math.cos(3*t)-7*Math.cos(4*t)+20
    );
  }

  var image=(function(){
    var c=document.createElement('canvas'),ctx=c.getContext('2d');
    c.width=settings.particles.size;c.height=settings.particles.size;
    function to(t){var p=pointOnHeart(t);p.x=settings.particles.size/2+p.x*settings.particles.size/350;p.y=settings.particles.size/2-p.y*settings.particles.size/350;return p}
    ctx.beginPath();var t=-Math.PI,p=to(t);ctx.moveTo(p.x,p.y);
    while(t<Math.PI){t+=0.01;p=to(t);ctx.lineTo(p.x,p.y)}
    ctx.closePath();ctx.fillStyle='#FF5CA4';ctx.fill();
    var img=new Image();img.src=c.toDataURL();return img;
  })();

  function render(){
    requestAnimationFrame(render);
    var newTime=new Date().getTime()/1000,dt=newTime-(time||newTime);time=newTime;
    context.clearRect(0,0,canvas.width,canvas.height);
    var amount=rate*dt;
    for(var i=0;i<amount;i++){
      var pos=pointOnHeart(Math.PI-2*Math.PI*Math.random());
      var dir=pos.clone().length(settings.particles.velocity);
      pool.add(canvas.width/2+pos.x,canvas.height/2-pos.y,dir.x,-dir.y)
    }
    pool.update(dt);
    pool.draw(context,image)
  }

  function onResize(){
    canvas.width=280;
    canvas.height=280;
  }
  onResize();
  render();
}
</script>
</body>
</html>


